<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link href="/favicon.ico" rel="icon"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="#000000" name="theme-color"><link href="/logo192.png" rel="apple-touch-icon"><link href="/manifest.json" rel="manifest"><title>Arthur Dayton Blog Site</title><link href="/static/css/main.0d183a93.chunk.css" rel="stylesheet"><style data-emotion="css">.css-vurnku{box-sizing:border-box;margin:0;min-width:0}.css-oxi7wx{box-sizing:border-box;margin:0;min-width:0;padding-bottom:8px}@media screen and (min-width:40em){.css-oxi7wx{padding-bottom:8px}}@media screen and (min-width:52em){.css-oxi7wx{padding-bottom:32px}}.css-1o61k66{box-sizing:border-box;margin:0;min-width:0;background-color:#000;-webkit-box-align:center;align-items:center;display:flex}.css-ozbgqc{box-sizing:border-box;margin:0;min-width:0;max-width:100%;width:54.4px;height:37px;border-radius:0;display:none}@media screen and (min-width:40em){.css-ozbgqc{width:108.8px;height:74px}}@media screen and (min-width:52em){.css-ozbgqc{width:136px;height:92.5px}}@media screen and (min-width:40em){.css-ozbgqc{display:block}}@media screen and (min-width:52em){.css-ozbgqc{display:block}}.css-1nqru1l{box-sizing:border-box;margin:0;min-width:0;color:#e9ecf5;font-weight:700;font-size:1.5em;text-decoration:none;padding:4px;display:none}@media screen and (min-width:40em){.css-1nqru1l{padding:16px}}@media screen and (min-width:52em){.css-1nqru1l{padding:16px}}.css-1nqru1l:hover{color:#ccd6eb;font-weight:900}@media screen and (min-width:40em){.css-1nqru1l{display:block}}@media screen and (min-width:52em){.css-1nqru1l{display:block}}.css-1ntkiwo{box-sizing:border-box;margin:0 auto;min-width:0}.css-hrpk47{box-sizing:border-box;margin:0;min-width:0;color:#e9ecf5;font-weight:700;text-decoration:none;padding:4px 32px 4px 4px;display:block;font-size:20px}@media screen and (min-width:40em){.css-hrpk47{padding:16px}}@media screen and (min-width:52em){.css-hrpk47{padding:16px}}.css-hrpk47:hover{color:#ccd6eb;font-weight:900}@media screen and (min-width:40em){.css-hrpk47{display:none;font-size:24px}}@media screen and (min-width:52em){.css-hrpk47{display:none;font-size:24px}}.css-1co1q8w{box-sizing:border-box;margin:0;min-width:0;background-color:#ccd6eb;display:none}.css-1wc86sm{box-sizing:border-box;margin:0;min-width:0;flex-wrap:wrap;text-align:right;display:flex}.css-npj7sz{box-sizing:border-box;margin:0;min-width:0;width:100%;padding:8px}.css-10yqanw{box-sizing:border-box;margin:0;min-width:0;color:#566db3;font-weight:700;font-size:1em;text-decoration:none;padding:16px}.css-10yqanw:hover{color:#ccd6eb;font-weight:900}.css-7um157{box-sizing:border-box;margin:0;min-width:0;height:37px}@media screen and (min-width:40em){.css-7um157{height:74px}}@media screen and (min-width:52em){.css-7um157{height:92.5px}}.css-1u6ks9t{box-sizing:border-box;margin:0;min-width:0;padding-left:8px}@media screen and (min-width:40em){.css-1u6ks9t{padding-left:8px}}@media screen and (min-width:52em){.css-1u6ks9t{padding-left:32px}}.css-93hpa0{box-sizing:border-box;margin:0;min-width:0;padding:0;font-family:arial}@media screen and (min-width:40em){.css-93hpa0{padding:8px}}@media screen and (min-width:52em){.css-93hpa0{padding:32px}}.css-1vzt88e{box-sizing:border-box;margin:0;min-width:0;padding-left:0;padding-top:0;padding-bottom:0}@media screen and (min-width:40em){.css-1vzt88e{padding-left:8px;padding-top:8px;padding-bottom:8px}}@media screen and (min-width:52em){.css-1vzt88e{padding-left:32px;padding-top:32px;padding-bottom:32px}}.css-yz2fnm{box-sizing:border-box;margin:0;min-width:0;font-size:24px;color:#000;font-family:Arial,sans-serif}.css-1bo66fg{box-sizing:border-box;margin:0;min-width:0;color:#000;font-family:Arial,sans-serif;font-size:.75em;padding-left:8px;padding-top:8px}.css-18ybmw{box-sizing:border-box;margin:0;min-width:0;color:#000;font-family:Arial,sans-serif;font-size:.75em;padding-left:8px}.css-4ax88y{box-sizing:border-box;margin:0;min-width:0;color:#000;font-family:Arial,sans-serif;font-size:.75em;padding-left:8px;padding-bottom:8px}.css-1ucrkln{box-sizing:border-box;margin:0;min-width:0;padding-top:8px;padding-left:0}@media screen and (min-width:40em){.css-1ucrkln{padding-left:8px}}@media screen and (min-width:52em){.css-1ucrkln{padding-left:32px}}.css-iyq5fi{box-sizing:border-box;margin:0;min-width:0;padding-left:0;padding-top:8px;padding-bottom:8px}@media screen and (min-width:40em){.css-iyq5fi{padding-left:8px}}@media screen and (min-width:52em){.css-iyq5fi{padding-left:16px}}.css-1lyp5n8{box-sizing:border-box;margin:8px 0;min-width:0}@media screen and (min-width:40em){.css-1lyp5n8{margin-left:8px}}@media screen and (min-width:52em){.css-1lyp5n8{margin-left:32px}}.css-1stgykt{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;padding:32px;vertical-align:middle}.css-3gdh81{box-sizing:border-box;margin:0;min-width:0;padding:32px}.css-1uzs5fn{box-sizing:border-box;margin:0;min-width:0;padding-top:0;padding-bottom:0;padding-left:0;font-size:.75em}@media screen and (min-width:40em){.css-1uzs5fn{padding-top:8px;padding-bottom:8px;padding-left:8px;font-size:1.5em}}@media screen and (min-width:52em){.css-1uzs5fn{padding-top:32px;padding-bottom:32px;padding-left:16px;font-size:1.5em}}</style><script src="/static/js/160.b424bf2f.chunk.js" charset="utf-8"></script><script src="/static/js/154.730b755d.chunk.js" charset="utf-8"></script><script src="/static/js/react-syntax-highlighter_languages_refractor_json.4e8e5b51.chunk.js" charset="utf-8"></script><script src="/static/js/react-syntax-highlighter_languages_refractor_yaml.aaa07edf.chunk.js" charset="utf-8"></script><meta content="article" data-react-helmet="true" property="og:type"><meta content="Serverless Web Application Deployement on AWS" data-react-helmet="true" property="og:title" name="title"><meta content="https://arthurdayton.com/post/6/" data-react-helmet="true" property="og:url"><meta content="%PUBLIC_URL%/images/6/preview.png" data-react-helmet="true" property="og:image" name="image"><meta content="This post shows the code for deploying a serverless application to AWS using Terraform, React, GraphQL and GitHub Actions." data-react-helmet="true" property="og:description" name="description"><meta content="Arthur Dayton" data-react-helmet="true" property="article:author" name="author"><meta content="2022-02-16" data-react-helmet="true" property="article:published_time" name="published_time"><meta content="Terraform" data-react-helmet="true" property="article:tag"><meta content="AWS" data-react-helmet="true" property="article:tag"><meta content="React" data-react-helmet="true" property="article:tag"><meta content="Cloudfront" data-react-helmet="true" property="article:tag"><meta content="Route53" data-react-helmet="true" property="article:tag"><meta content="GraphQL" data-react-helmet="true" property="article:tag"><meta content="ACM" data-react-helmet="true" property="article:tag"><meta content="GitHub Actions" data-react-helmet="true" property="article:tag"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="css-vurnku" style="position:fixed;width:100%"><div class="css-oxi7wx"><div class="css-1o61k66"><img class="css-ozbgqc" src="/static/media/ObservatoryPark.ba50a4b1.jpg"><a href="/blog" class="css-1nqru1l">Blog</a><a href="/about" class="css-1nqru1l">About</a><a class="css-1nqru1l" id="logOnButton">LogIn</a><div class="css-1ntkiwo"></div><div class="css-hrpk47"><svg fill="currentColor" height="1em" stroke="currentColor" stroke-width="0" viewBox="0 0 448 512" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"></path></svg></div></div><div class="css-1co1q8w"><div class="css-1wc86sm"><div class="css-npj7sz"><a href="/blog" class="css-10yqanw">Blog</a></div><div class="css-npj7sz"><a href="/about" class="css-10yqanw">About</a></div></div></div></div></div><div class="css-7um157"></div><div class="css-1u6ks9t"><div class="css-vurnku" id="post_page_parent_6"><div class="css-93hpa0"><div class="css-1vzt88e"><h1 class="css-yz2fnm">Deploying This Blog Site Using Serverless Technologies on AWS</h1><h5 class="css-1bo66fg"><div class="css-vurnku">Tech: React - GraphQL - Terraform - AWS</div></h5><h5 class="css-18ybmw">Posted: 2022-02-15</h5><h5 class="css-4ax88y">Last Updated: 2022-02-15</h5></div><div class="css-1ucrkln"><div><div class="css-iyq5fi"><h4 class="css-yz2fnm">Using GitHub Actions to continuously deploy a Serverless blog site</h4></div><div class="css-1lyp5n8">In this post I am going to cover how to use <a href="https://docs.github.com/en/actions" target="_blank">GitHub Actions</a> to continuously build and deploy a serverless web application (this site) using <a href="https://www.terraform.io/" target="_blank">Terraform</a>, <a href="https://reactjs.org/" target="_blank">React</a>, <a href="https://graphql.org/" target="_blank">GraphQL</a>, and several AWS services including <a href="https://aws.amazon.com/lambda/" target="_blank">Lambda</a>, <a href="https://aws.amazon.com/api-gateway/" target="_blank">API Gateway</a>, <a href="https://aws.amazon.com/s3/" target="_blank">S3</a>, <a href="https://aws.amazon.com/sns/" target="_blank">SNS</a>, <a href="https://aws.amazon.com/route53/" target="_blank">Route53</a>, <a href="https://aws.amazon.com/certificate-manager/" target="_blank">Certificate Manager</a> and <a href="https://aws.amazon.com/cloudfront/" target="_blank">CloudFront</a>.</div><br><details style="padding-left:1em" open><summary><strong>Diagram of what I am implementing:</strong></summary><img class="css-1stgykt" src="/images/6/ArchitectureDiagram.png"></details><br><div class="css-1lyp5n8">To set this up yourself you need an <a href="https://aws.amazon.com/account/" target="_blank">AWS account</a>, a <a href="https://cloud.hashicorp.com/products/terraform" target="_blank">Terraform Cloud account</a>, a <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-register.html" target="_blank">custom domain</a>, basic React skills, basic Terraform skills, a working knowledge of GitHub Actions and of course the requisite amount of OCD needed to figure out the stuff I almost certainly left out (I wouldn't want to deny you the sweet pain of experience).</div><br><div class="css-1lyp5n8">I started with the <a href="https://create-react-app.dev/" target="_blank">Create React App</a> and built off of it <a href="https://arthurdayton.com/post/1/" target="_blank">How to set up a Git Hub Pages Blog Site Using React and MDX</a>. The approach for using S3 to serve the static site assets is essentially the same as using GitHub pages but when you start to think about putting an API on the back end I think it's "easier" to use AWS.</div><br><details style="padding-left:1em" open><summary><strong>A little background reading from around the internet:</strong></summary><br><br><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/HostingWebsiteOnS3Setup.html" target="_blank" class="css-3gdh81">S3 Static Site Setup</a><br><div class="css-1lyp5n8">S3 (Simple Storage Service) is definitely the <a href="https://en.wikipedia.org/wiki/Amazon_S3" target="_blank">the OG of AWS</a> . It's cheap (It currrently costs me less than 5 cents a month), easy to use(<a href="https://threatpost.com/sega-security-aws-s3-exposed-steam/177352/" target="_blank">to easy?</a>), and pretty seamlessly integrates with lots of other AWS resources, such as Cloudfront.</div><br><a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudfront-serve-static-website/" target="_blank" class="css-3gdh81">CloudFront Setup</a><br><div class="css-1lyp5n8">Cloudfront is a CDN which allows users to cache content around the world and automatically integrates with S3 and Route53 so we can easily map our domain to our content.</div><br><a href="https://wolovim.medium.com/deploying-create-react-app-to-s3-or-cloudfront-48dae4ce0af" target="_blank" class="css-3gdh81">This post does a great job of explaining how to integrate S3 and Cloudfront</a><br></details><br><br><div class="css-1lyp5n8"><h2>Building out components of architecture diagram</h2></div><div class="css-1lyp5n8">To build out my architecture diagram above I use Terraform to define my AWS resources, the AWS CLI to push my React code to my S3 bucket, and a GitHub Actions pipeline to deploy whenever I push changes to the main branch of my repository. My API is Apollo GraphQL (<a href="https://www.apollographql.com/" target="_blank">‚ù§Ô∏è‚Äçüî•</a>) for getting and submitting comments. It's running as a Lambda function (<a href="https://www.apollographql.com/docs/apollo-server/deployment/lambda/" target="_blank">ü§Ø</a>) and using DynamoDB as a data store so that this site is essentially free to deploy and will autoscale to any degree of usage.</div><br><div class="css-1lyp5n8">I could have easily used all AWS tools to do this, but I think there is good reason to stick with some tools that are Cloud agnostic as it becomes clearer every day that the enterprise cloud provider battle is going to work out like the enterprise database or development language battles (everybody is going to have pretty much everything).</div><br><a href="https://github.com/arthurdayton116/blog-site" target="_blank" class="css-3gdh81">Code Here</a><br><br><details style="padding-left:1em"><summary><h2 style="display:inline">Hosted Zone</h2><div class="css-1lyp5n8">If I want to reach the world then I'm going to need a domain and it will need to support SSL/TLS certificates so I'm using Route53 and ACM (Amazon Certificate Manager) to purchase and renew both. My hosted zone in Route53 will route traffic to my Cloudfront distributions for my React site and my GraphQL endpoint. I will need to create those Cloudfront distributions of course, which I show below. As I go along, I will be creating Terraform files for the creation of all resources so that I can easily create and destroy on demand as well as make the process of deploying my site automated and reusable.</div></summary><br><details style="padding-left:1em"><summary><strong>Basic Terraform code looks like this:</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px"><span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// hosted zone</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_zone"</span> <span class="token" style="color:#f1fa8c">"main"</span> <span class="token punctuation">{</span> name = local.bucket_name <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// gmail record</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_record"</span> <span class="token" style="color:#f1fa8c">"gmail_mx"</span> <span class="token punctuation">{</span> zone_id = aws_route<span class="token" style="color:#bd93f9">53</span>_zone.main.zone_id name = local.bucket_name type = <span class="token" style="color:#f1fa8c">"MX"</span> records = <span class="token punctuation">[</span> <span class="token" style="color:#f1fa8c">"1 ASPMX.L.GOOGLE.COM"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"5 ALT1.ASPMX.L.GOOGLE.COM"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"5 ALT2.ASPMX.L.GOOGLE.COM"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"10 ALT3.ASPMX.L.GOOGLE.COM"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"10 ALT4.ASPMX.L.GOOGLE.COM"</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> ttl = <span class="token" style="color:#f1fa8c">"300"</span> <span class="token punctuation">}</span></code></span></div></div></details><br><div class="css-1lyp5n8">The most important thing to remember, especially if you are switching what your domain points at, is that when you are sure it's not DNS it's probably DNS.</div><div class="css-1lyp5n8">This shows my hosted zone in the AWS Console:</div><img class="css-1stgykt" src="/images/6/hostedzone.png"><div class="css-1lyp5n8">These are the records pointing to my cloudfront distributions:</div><img class="css-1stgykt" src="/images/6/hostedzone2.png"><div class="css-1lyp5n8">This shows the record detail and how to point to a Cloudfront distribution (I use Terrraform to create these when I deploy to Cloudfront below):</div><img class="css-1stgykt" src="/images/6/hzrecord.png"><br><br></details><br><details style="padding-left:1em"><summary><h2 style="display:inline">Certificate</h2><div class="css-1lyp5n8">Using ACM you can create a certificate for your domain and have it automatically validate by creating records in your hosted zone</div></summary><br><div class="css-1lyp5n8">This shows the certificate status and domain validation status in the ACM panel:</div><img class="css-1stgykt" src="/images/6/acm2.png"><div class="css-1lyp5n8">This shows the records created by the validation process (we can use Terraform for this as well):</div><img class="css-1stgykt" src="/images/6/certrecord.png"><br><br><details style="padding-left:1em"><summary><strong>Terraform code:</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21 </span><span class="react-syntax-highlighter-line-number">22 </span><span class="react-syntax-highlighter-line-number">23 </span><span class="react-syntax-highlighter-line-number">24 </span><span class="react-syntax-highlighter-line-number">25 </span><span class="react-syntax-highlighter-line-number">26 </span><span class="react-syntax-highlighter-line-number">27 </span><span class="react-syntax-highlighter-line-number">28 </span><span class="react-syntax-highlighter-line-number">29 </span><span class="react-syntax-highlighter-line-number">30 </span><span class="react-syntax-highlighter-line-number">31 </span><span class="react-syntax-highlighter-line-number">32 </span><span class="react-syntax-highlighter-line-number">33 </span><span class="react-syntax-highlighter-line-number">34 </span><span class="react-syntax-highlighter-line-number">35 </span><span class="react-syntax-highlighter-line-number">36 </span><span class="react-syntax-highlighter-line-number">37 </span><span class="react-syntax-highlighter-line-number">38 </span><span class="react-syntax-highlighter-line-number">39 </span><span class="react-syntax-highlighter-line-number">40 </span><span class="react-syntax-highlighter-line-number">41 </span><span class="react-syntax-highlighter-line-number">42 </span><span class="react-syntax-highlighter-line-number">43 </span><span class="react-syntax-highlighter-line-number">44 </span><span class="react-syntax-highlighter-line-number">45 </span><span class="react-syntax-highlighter-line-number">46 </span><span class="react-syntax-highlighter-line-number">47 </span><span class="react-syntax-highlighter-line-number">48 </span><span class="react-syntax-highlighter-line-number">49 </span><span class="react-syntax-highlighter-line-number">50 </span><span class="react-syntax-highlighter-line-number">51 </span><span class="react-syntax-highlighter-line-number">52 </span><span class="react-syntax-highlighter-line-number">53 </span><span class="react-syntax-highlighter-line-number">54 </span><span class="react-syntax-highlighter-line-number">55 </span><span class="react-syntax-highlighter-line-number">56 </span><span class="react-syntax-highlighter-line-number">57 </span><span class="react-syntax-highlighter-line-number">58 </span><span class="react-syntax-highlighter-line-number">59 </span><span class="react-syntax-highlighter-line-number">60 </span><span class="react-syntax-highlighter-line-number">61 </span><span class="react-syntax-highlighter-line-number">62 </span><span class="react-syntax-highlighter-line-number">63</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px"><span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">//domain certificate</span> resource <span class="token" style="color:#f1fa8c">"aws_acm_certificate"</span> <span class="token" style="color:#f1fa8c">"a"</span> <span class="token punctuation">{</span> domain_name = local.bucket_name subject_alternative_names = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"www.${local.bucket_name}"</span><span class="token punctuation">]</span> validation_method = <span class="token" style="color:#f1fa8c">"DNS"</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// validate that we have control over domain so our certificate is trusted</span> resource <span class="token" style="color:#f1fa8c">"aws_acm_certificate_validation"</span> <span class="token" style="color:#f1fa8c">"example"</span> <span class="token punctuation">{</span> certificate_arn = aws_acm_certificate.a.arn <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// loop route records which are the domain name and subject_alternative_names from aws_acm_certificate resource</span> validation_record_fqdns = <span class="token punctuation">[</span>for record in aws_route<span class="token" style="color:#bd93f9">53</span>_record.example <span class="token operator">:</span> record.fqdn<span class="token punctuation">]</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_record"</span> <span class="token" style="color:#f1fa8c">"example"</span> <span class="token punctuation">{</span> for_each = <span class="token punctuation">{</span> for dvo in aws_acm_certificate.a.domain_validation_options <span class="token operator">:</span> dvo.domain_name => <span class="token punctuation">{</span> name = dvo.resource_record_name record = dvo.resource_record_value type = dvo.resource_record_type zone_id = aws_route<span class="token" style="color:#bd93f9">53</span>_zone.main.zone_id <span class="token punctuation">}</span> <span class="token punctuation">}</span> allow_overwrite = <span class="token boolean">true</span> name = each.value.name records = <span class="token punctuation">[</span>each.value.record<span class="token punctuation">]</span> ttl = <span class="token" style="color:#bd93f9">60</span> type = each.value.type zone_id = each.value.zone_id <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// graphql certificate</span> resource <span class="token" style="color:#f1fa8c">"aws_acm_certificate"</span> <span class="token" style="color:#f1fa8c">"graphql"</span> <span class="token punctuation">{</span> domain_name = local.bucket_name subject_alternative_names = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"graphql.${local.bucket_name}"</span><span class="token punctuation">]</span> validation_method = <span class="token" style="color:#f1fa8c">"DNS"</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_acm_certificate_validation"</span> <span class="token" style="color:#f1fa8c">"graphql"</span> <span class="token punctuation">{</span> certificate_arn = aws_acm_certificate.graphql.arn validation_record_fqdns = <span class="token punctuation">[</span>for record in aws_route<span class="token" style="color:#bd93f9">53</span>_record.graphql <span class="token operator">:</span> record.fqdn<span class="token punctuation">]</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_record"</span> <span class="token" style="color:#f1fa8c">"graphql"</span> <span class="token punctuation">{</span> for_each = <span class="token punctuation">{</span> for dvo in aws_acm_certificate.graphql.domain_validation_options <span class="token operator">:</span> dvo.domain_name => <span class="token punctuation">{</span> name = dvo.resource_record_name record = dvo.resource_record_value type = dvo.resource_record_type zone_id = aws_route<span class="token" style="color:#bd93f9">53</span>_zone.main.zone_id <span class="token punctuation">}</span> <span class="token punctuation">}</span> allow_overwrite = <span class="token boolean">true</span> name = each.value.name records = <span class="token punctuation">[</span>each.value.record<span class="token punctuation">]</span> ttl = <span class="token" style="color:#bd93f9">60</span> type = each.value.type zone_id = each.value.zone_id <span class="token punctuation">}</span></code></span></div></div></details></details><br><details style="padding-left:1em"><summary><h2 style="display:inline">Cloudfront</h2><div class="css-1lyp5n8">After creating a Cloudfront distribution for my S3 bucket, that I set as an origin, I can point the name records in Route53 at Cloudfront which I showed in the Hosted Zone section above. As with everything else we can automate and manage these with Terraform.</div></summary><br><div class="css-1lyp5n8">This shows my distribution for site assets:</div><img class="css-1stgykt" src="/images/6/cloudfront.png"><img class="css-1stgykt" src="/images/6/cloudfront2.png"><div class="css-1lyp5n8">This shows the configured S3 bucket origin where my React build artifacts are pushed from the GitHub Actions pipeline that runs when I commit to my repository:</div><img class="css-1stgykt" src="/images/6/cloudfront3.png"><br><br><details style="padding-left:1em"><summary><strong>Terraform code:</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21 </span><span class="react-syntax-highlighter-line-number">22 </span><span class="react-syntax-highlighter-line-number">23 </span><span class="react-syntax-highlighter-line-number">24 </span><span class="react-syntax-highlighter-line-number">25 </span><span class="react-syntax-highlighter-line-number">26 </span><span class="react-syntax-highlighter-line-number">27 </span><span class="react-syntax-highlighter-line-number">28 </span><span class="react-syntax-highlighter-line-number">29 </span><span class="react-syntax-highlighter-line-number">30 </span><span class="react-syntax-highlighter-line-number">31 </span><span class="react-syntax-highlighter-line-number">32 </span><span class="react-syntax-highlighter-line-number">33 </span><span class="react-syntax-highlighter-line-number">34 </span><span class="react-syntax-highlighter-line-number">35 </span><span class="react-syntax-highlighter-line-number">36 </span><span class="react-syntax-highlighter-line-number">37 </span><span class="react-syntax-highlighter-line-number">38 </span><span class="react-syntax-highlighter-line-number">39 </span><span class="react-syntax-highlighter-line-number">40 </span><span class="react-syntax-highlighter-line-number">41 </span><span class="react-syntax-highlighter-line-number">42 </span><span class="react-syntax-highlighter-line-number">43 </span><span class="react-syntax-highlighter-line-number">44 </span><span class="react-syntax-highlighter-line-number">45 </span><span class="react-syntax-highlighter-line-number">46 </span><span class="react-syntax-highlighter-line-number">47 </span><span class="react-syntax-highlighter-line-number">48 </span><span class="react-syntax-highlighter-line-number">49 </span><span class="react-syntax-highlighter-line-number">50 </span><span class="react-syntax-highlighter-line-number">51 </span><span class="react-syntax-highlighter-line-number">52 </span><span class="react-syntax-highlighter-line-number">53 </span><span class="react-syntax-highlighter-line-number">54 </span><span class="react-syntax-highlighter-line-number">55 </span><span class="react-syntax-highlighter-line-number">56 </span><span class="react-syntax-highlighter-line-number">57 </span><span class="react-syntax-highlighter-line-number">58 </span><span class="react-syntax-highlighter-line-number">59 </span><span class="react-syntax-highlighter-line-number">60 </span><span class="react-syntax-highlighter-line-number">61 </span><span class="react-syntax-highlighter-line-number">62 </span><span class="react-syntax-highlighter-line-number">63 </span><span class="react-syntax-highlighter-line-number">64 </span><span class="react-syntax-highlighter-line-number">65 </span><span class="react-syntax-highlighter-line-number">66 </span><span class="react-syntax-highlighter-line-number">67 </span><span class="react-syntax-highlighter-line-number">68 </span><span class="react-syntax-highlighter-line-number">69 </span><span class="react-syntax-highlighter-line-number">70 </span><span class="react-syntax-highlighter-line-number">71 </span><span class="react-syntax-highlighter-line-number">72 </span><span class="react-syntax-highlighter-line-number">73 </span><span class="react-syntax-highlighter-line-number">74 </span><span class="react-syntax-highlighter-line-number">75 </span><span class="react-syntax-highlighter-line-number">76 </span><span class="react-syntax-highlighter-line-number">77 </span><span class="react-syntax-highlighter-line-number">78 </span><span class="react-syntax-highlighter-line-number">79 </span><span class="react-syntax-highlighter-line-number">80 </span><span class="react-syntax-highlighter-line-number">81 </span><span class="react-syntax-highlighter-line-number">82 </span><span class="react-syntax-highlighter-line-number">83 </span><span class="react-syntax-highlighter-line-number">84 </span><span class="react-syntax-highlighter-line-number">85 </span><span class="react-syntax-highlighter-line-number">86 </span><span class="react-syntax-highlighter-line-number">87 </span><span class="react-syntax-highlighter-line-number">88 </span><span class="react-syntax-highlighter-line-number">89 </span><span class="react-syntax-highlighter-line-number">90 </span><span class="react-syntax-highlighter-line-number">91 </span><span class="react-syntax-highlighter-line-number">92 </span><span class="react-syntax-highlighter-line-number">93 </span><span class="react-syntax-highlighter-line-number">94 </span><span class="react-syntax-highlighter-line-number">95 </span><span class="react-syntax-highlighter-line-number">96 </span><span class="react-syntax-highlighter-line-number">97</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px">locals <span class="token punctuation">{</span> s<span class="token" style="color:#bd93f9">3</span>_origin_id = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}_${local.bucket_name}_a"</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_cloudfront_distribution"</span> <span class="token" style="color:#f1fa8c">"s3_distribution_a"</span> <span class="token punctuation">{</span> origin <span class="token punctuation">{</span> domain_name = local.s<span class="token" style="color:#bd93f9">3</span>_web_endpoint origin_id = local.s<span class="token" style="color:#bd93f9">3</span>_origin_id <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// https://github.com/hashicorp/terraform-provider-aws/issues/7847</span> custom_origin_config <span class="token punctuation">{</span> http_port = <span class="token" style="color:#f1fa8c">"80"</span> https_port = <span class="token" style="color:#f1fa8c">"443"</span> origin_protocol_policy = <span class="token" style="color:#f1fa8c">"http-only"</span> origin_ssl_protocols = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"TLSv1"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"TLSv1.1"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"TLSv1.2"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> enabled = <span class="token boolean">true</span> is_ipv<span class="token" style="color:#bd93f9">6</span>_enabled = <span class="token boolean">true</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// comment = </span><span class="token" style="color:#f1fa8c">""</span> default_root_object = <span class="token" style="color:#f1fa8c">"index.html"</span> logging_config <span class="token punctuation">{</span> include_cookies = <span class="token boolean">false</span> bucket = local.log_bucket_name prefix = local.resource_prefix <span class="token punctuation">}</span> aliases = <span class="token punctuation">[</span>local.bucket_name<span class="token punctuation">,</span> local.alt_name<span class="token punctuation">]</span> default_cache_behavior <span class="token punctuation">{</span> allowed_methods = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"DELETE"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"GET"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"HEAD"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"OPTIONS"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"PATCH"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"POST"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"PUT"</span><span class="token punctuation">]</span> cached_methods = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"GET"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"HEAD"</span><span class="token punctuation">]</span> target_origin_id = local.s<span class="token" style="color:#bd93f9">3</span>_origin_id forwarded_values <span class="token punctuation">{</span> query_string = <span class="token boolean">false</span> cookies <span class="token punctuation">{</span> forward = <span class="token" style="color:#f1fa8c">"none"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> viewer_protocol_policy = <span class="token" style="color:#f1fa8c">"https-only"</span> min_ttl = <span class="token" style="color:#bd93f9">0</span> default_ttl = <span class="token" style="color:#bd93f9">3600</span> max_ttl = <span class="token" style="color:#bd93f9">86400</span> <span class="token punctuation">}</span> price_class = <span class="token" style="color:#f1fa8c">"PriceClass_All"</span> restrictions <span class="token punctuation">{</span> geo_restriction <span class="token punctuation">{</span> restriction_type = <span class="token" style="color:#f1fa8c">"none"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> tags = merge( local.base_tags<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-${local.bucket_name}"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> ) viewer_certificate <span class="token punctuation">{</span> acm_certificate_arn = local.cert_arn ssl_support_method = <span class="token" style="color:#f1fa8c">"sni-only"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Create subdomain A record pointing to Cloudfront distribution</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_record"</span> <span class="token" style="color:#f1fa8c">"www"</span> <span class="token punctuation">{</span> zone_id = local.zone_id name = <span class="token" style="color:#f1fa8c">"www.${local.bucket_name}"</span> type = <span class="token" style="color:#f1fa8c">"A"</span> alias <span class="token punctuation">{</span> name = aws_cloudfront_distribution.s<span class="token" style="color:#bd93f9">3</span>_distribution_a.domain_name zone_id = aws_cloudfront_distribution.s<span class="token" style="color:#bd93f9">3</span>_distribution_a.hosted_zone_id evaluate_target_health = <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Create domain A record pointing to Cloudfront distribution</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_record"</span> <span class="token" style="color:#f1fa8c">"a"</span> <span class="token punctuation">{</span> zone_id = local.zone_id name = local.bucket_name type = <span class="token" style="color:#f1fa8c">"A"</span> alias <span class="token punctuation">{</span> name = aws_cloudfront_distribution.s<span class="token" style="color:#bd93f9">3</span>_distribution_a.domain_name zone_id = aws_cloudfront_distribution.s<span class="token" style="color:#bd93f9">3</span>_distribution_a.hosted_zone_id evaluate_target_health = <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></span></div></div></details></details><br><details style="padding-left:1em"><summary><h2 style="display:inline">S3 Buckets</h2><div class="css-1lyp5n8">For this site I'm using 2 S3 buckets. One for the site assets that we will use as a source for our CloudFront distribution and one for logs and Athena query results.</div></summary><br><div class="css-1lyp5n8">This shows the buckets:</div><img class="css-1stgykt" src="/images/6/S3list.png"><div class="css-1lyp5n8">This shows the site assets from React build:</div><img class="css-1stgykt" src="/images/6/S3assets.png"><div class="css-1lyp5n8">This shows relevant properties for site assets bucket:</div><img class="css-1stgykt" src="/images/6/S3domain.png"><img class="css-1stgykt" src="/images/6/S3www.png"><details style="padding-left:1em"><summary><strong>Terraform code:</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21 </span><span class="react-syntax-highlighter-line-number">22 </span><span class="react-syntax-highlighter-line-number">23 </span><span class="react-syntax-highlighter-line-number">24 </span><span class="react-syntax-highlighter-line-number">25 </span><span class="react-syntax-highlighter-line-number">26 </span><span class="react-syntax-highlighter-line-number">27 </span><span class="react-syntax-highlighter-line-number">28 </span><span class="react-syntax-highlighter-line-number">29 </span><span class="react-syntax-highlighter-line-number">30 </span><span class="react-syntax-highlighter-line-number">31 </span><span class="react-syntax-highlighter-line-number">32 </span><span class="react-syntax-highlighter-line-number">33 </span><span class="react-syntax-highlighter-line-number">34 </span><span class="react-syntax-highlighter-line-number">35 </span><span class="react-syntax-highlighter-line-number">36 </span><span class="react-syntax-highlighter-line-number">37 </span><span class="react-syntax-highlighter-line-number">38 </span><span class="react-syntax-highlighter-line-number">39 </span><span class="react-syntax-highlighter-line-number">40 </span><span class="react-syntax-highlighter-line-number">41 </span><span class="react-syntax-highlighter-line-number">42 </span><span class="react-syntax-highlighter-line-number">43 </span><span class="react-syntax-highlighter-line-number">44 </span><span class="react-syntax-highlighter-line-number">45 </span><span class="react-syntax-highlighter-line-number">46 </span><span class="react-syntax-highlighter-line-number">47 </span><span class="react-syntax-highlighter-line-number">48 </span><span class="react-syntax-highlighter-line-number">49 </span><span class="react-syntax-highlighter-line-number">50 </span><span class="react-syntax-highlighter-line-number">51 </span><span class="react-syntax-highlighter-line-number">52 </span><span class="react-syntax-highlighter-line-number">53 </span><span class="react-syntax-highlighter-line-number">54 </span><span class="react-syntax-highlighter-line-number">55 </span><span class="react-syntax-highlighter-line-number">56 </span><span class="react-syntax-highlighter-line-number">57 </span><span class="react-syntax-highlighter-line-number">58 </span><span class="react-syntax-highlighter-line-number">59 </span><span class="react-syntax-highlighter-line-number">60 </span><span class="react-syntax-highlighter-line-number">61 </span><span class="react-syntax-highlighter-line-number">62 </span><span class="react-syntax-highlighter-line-number">63 </span><span class="react-syntax-highlighter-line-number">64 </span><span class="react-syntax-highlighter-line-number">65 </span><span class="react-syntax-highlighter-line-number">66 </span><span class="react-syntax-highlighter-line-number">67 </span><span class="react-syntax-highlighter-line-number">68 </span><span class="react-syntax-highlighter-line-number">69 </span><span class="react-syntax-highlighter-line-number">70 </span><span class="react-syntax-highlighter-line-number">71 </span><span class="react-syntax-highlighter-line-number">72 </span><span class="react-syntax-highlighter-line-number">73 </span><span class="react-syntax-highlighter-line-number">74 </span><span class="react-syntax-highlighter-line-number">75 </span><span class="react-syntax-highlighter-line-number">76 </span><span class="react-syntax-highlighter-line-number">77 </span><span class="react-syntax-highlighter-line-number">78 </span><span class="react-syntax-highlighter-line-number">79 </span><span class="react-syntax-highlighter-line-number">80 </span><span class="react-syntax-highlighter-line-number">81 </span><span class="react-syntax-highlighter-line-number">82 </span><span class="react-syntax-highlighter-line-number">83 </span><span class="react-syntax-highlighter-line-number">84 </span><span class="react-syntax-highlighter-line-number">85 </span><span class="react-syntax-highlighter-line-number">86 </span><span class="react-syntax-highlighter-line-number">87 </span><span class="react-syntax-highlighter-line-number">88 </span><span class="react-syntax-highlighter-line-number">89 </span><span class="react-syntax-highlighter-line-number">90 </span><span class="react-syntax-highlighter-line-number">91 </span><span class="react-syntax-highlighter-line-number">92 </span><span class="react-syntax-highlighter-line-number">93</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px"><span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// root domain bucket and policy</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Clean up bucket for destroy aws s3 rm s3://bucketname --recursive</span> resource <span class="token" style="color:#f1fa8c">"aws_s3_bucket"</span> <span class="token" style="color:#f1fa8c">"a"</span> <span class="token punctuation">{</span> bucket = local.bucket_name <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// For a React site the index needs to be error document as well and React needs to handle errors</span> website <span class="token punctuation">{</span> index_document = <span class="token" style="color:#f1fa8c">"index.html"</span> error_document = <span class="token" style="color:#f1fa8c">"index.html"</span> <span class="token punctuation">}</span> logging <span class="token punctuation">{</span> target_bucket = aws_s<span class="token" style="color:#bd93f9">3</span>_bucket.log.id target_prefix = <span class="token" style="color:#f1fa8c">"s3-log/"</span> <span class="token punctuation">}</span> force_destroy = <span class="token boolean">true</span> tags = merge( local.base_tags<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-${local.bucket_name}"</span> directory = basename(path.cwd) <span class="token punctuation">}</span><span class="token punctuation">,</span> ) <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_s3_bucket"</span> <span class="token" style="color:#f1fa8c">"log"</span> <span class="token punctuation">{</span> bucket = <span class="token" style="color:#f1fa8c">"logs-${local.bucket_name}"</span> force_destroy = <span class="token boolean">true</span> grant <span class="token punctuation">{</span> type = <span class="token" style="color:#f1fa8c">"Group"</span> permissions = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"READ_ACP"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"WRITE"</span><span class="token punctuation">]</span> uri = <span class="token" style="color:#f1fa8c">"http://acs.amazonaws.com/groups/s3/LogDelivery"</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">//CloudFront</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Permissions required to configure standard logging and to access your log files</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html</span> grant <span class="token punctuation">{</span> id = <span class="token" style="color:#f1fa8c">"c4c1ede66af53448b93c283ce9448c4ba468c9432aa01d700d3878632f77d2d0"</span> permissions = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"FULL_CONTROL"</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> type = <span class="token" style="color:#f1fa8c">"CanonicalUser"</span> <span class="token punctuation">}</span> grant <span class="token punctuation">{</span> id = data.aws_canonical_user_id.current_user.id type = <span class="token" style="color:#f1fa8c">"CanonicalUser"</span> permissions = <span class="token punctuation">[</span><span class="token" style="color:#f1fa8c">"FULL_CONTROL"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> tags = merge( local.base_tags<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-logs-${local.bucket_name}"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> ) <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_s3_bucket_object"</span> <span class="token" style="color:#f1fa8c">"log_query_folder"</span> <span class="token punctuation">{</span> bucket = aws_s<span class="token" style="color:#bd93f9">3</span>_bucket.log.id acl = <span class="token" style="color:#f1fa8c">"private"</span> key = <span class="token" style="color:#f1fa8c">"queryResults/"</span> source = <span class="token" style="color:#f1fa8c">"/dev/null"</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// This ensures that bucket content can be read publicly</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// I like setting it up this way so it's easier to test changes</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Check here for different setups - https://aws.amazon.com/premiumsupport/knowledge-center/cloudfront-serve-static-website/</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Policy limits to specific bucket</span> resource <span class="token" style="color:#f1fa8c">"aws_s3_bucket_policy"</span> <span class="token" style="color:#f1fa8c">"a"</span> <span class="token punctuation">{</span> bucket = aws_s<span class="token" style="color:#bd93f9">3</span>_bucket.a.id policy = jsonencode(<span class="token punctuation">{</span> Version = <span class="token" style="color:#f1fa8c">"2012-10-17"</span> Id = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-${local.bucket_name}-policy"</span> Statement = <span class="token punctuation">[</span> <span class="token punctuation">{</span> Sid = <span class="token" style="color:#f1fa8c">"PublicRead"</span> Effect = <span class="token" style="color:#f1fa8c">"Allow"</span> Principal = <span class="token" style="color:#f1fa8c">"*"</span> Action = <span class="token punctuation">[</span> <span class="token" style="color:#f1fa8c">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"s3:GetObjectVersion"</span> <span class="token punctuation">]</span> Resource = <span class="token punctuation">[</span> aws_s<span class="token" style="color:#bd93f9">3</span>_bucket.a.arn<span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"${aws_s3_bucket.a.arn}/*"</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>) <span class="token punctuation">}</span></code></span></div></div></details></details><br><details style="padding-left:1em"><summary><h2 style="display:inline">GitHub Actions</h2><div class="css-1lyp5n8">For my continuous integration I am using GitHub. Right now I am using the main branch and not a PR flow because it's just me and I can make it work with local dev and GitHub actions. In a context any larger than myself I would set up a separate dev domain either within a VPC or locked down by IP address. GitHub Actions is pretty awesome and it's been exciting watching it mature towards being an Enterprise ready tool. Care and feeding of architecture is painful and having this capability delivered right to my GitHub repository is awesome! If you've used Azure Devops (lately) then it will look and feel very familiar.</div></summary><div class="css-1lyp5n8"><h3>Environment</h3>First thing I needed to do was set up an environment in Actions so I can store secrets:</div><img class="css-1stgykt" src="/images/6/actionsenv.png"><div class="css-1lyp5n8"><h3>Actions Workflow</h3></div><div class="css-1lyp5n8">Then I can set up the yaml file that will define my workflow that runs whenever I commit code. GitHub has a default location for the file:</div><img class="css-1stgykt" src="/images/6/actionslocation.png"><div class="css-1lyp5n8">I reference my environment and then I can pull secrets into my build job runs securely:</div><img class="css-1stgykt" src="/images/6/yaml1.png"><div class="css-1lyp5n8">Now I can create all the steps needed to build this application from top to bottom:</div><div class="css-1lyp5n8"><h4>Set up dynamodb container for automated tests</h4></div><img class="css-1stgykt" src="/images/6/yaml2.png"><div class="css-1lyp5n8"><h4>Check out previous commit so we can see what files have changed and only run certain steps</h4></div><img class="css-1stgykt" src="/images/6/yaml3.png"><img class="css-1stgykt" src="/images/6/yaml4.png"><img class="css-1stgykt" src="/images/6/yaml5.png"><div class="css-1lyp5n8"><h4>Set up Terraform</h4></div><img class="css-1stgykt" src="/images/6/yaml6.png"><div class="css-1lyp5n8"><h4>Run Terraform apply if files have changed and set and environment variables needed for following steps</h4></div><img class="css-1stgykt" src="/images/6/yaml7.png"><div class="css-1lyp5n8"><h4>Build graphql code, zip for Lambda and create Lambda</h4></div><img class="css-1stgykt" src="/images/6/yaml8.png"><details style="padding-left:1em"><summary><strong>API Gateway Terraform:</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21 </span><span class="react-syntax-highlighter-line-number">22 </span><span class="react-syntax-highlighter-line-number">23 </span><span class="react-syntax-highlighter-line-number">24 </span><span class="react-syntax-highlighter-line-number">25 </span><span class="react-syntax-highlighter-line-number">26 </span><span class="react-syntax-highlighter-line-number">27 </span><span class="react-syntax-highlighter-line-number">28 </span><span class="react-syntax-highlighter-line-number">29 </span><span class="react-syntax-highlighter-line-number">30 </span><span class="react-syntax-highlighter-line-number">31 </span><span class="react-syntax-highlighter-line-number">32 </span><span class="react-syntax-highlighter-line-number">33 </span><span class="react-syntax-highlighter-line-number">34 </span><span class="react-syntax-highlighter-line-number">35 </span><span class="react-syntax-highlighter-line-number">36 </span><span class="react-syntax-highlighter-line-number">37 </span><span class="react-syntax-highlighter-line-number">38 </span><span class="react-syntax-highlighter-line-number">39 </span><span class="react-syntax-highlighter-line-number">40 </span><span class="react-syntax-highlighter-line-number">41 </span><span class="react-syntax-highlighter-line-number">42 </span><span class="react-syntax-highlighter-line-number">43 </span><span class="react-syntax-highlighter-line-number">44 </span><span class="react-syntax-highlighter-line-number">45 </span><span class="react-syntax-highlighter-line-number">46 </span><span class="react-syntax-highlighter-line-number">47 </span><span class="react-syntax-highlighter-line-number">48 </span><span class="react-syntax-highlighter-line-number">49 </span><span class="react-syntax-highlighter-line-number">50 </span><span class="react-syntax-highlighter-line-number">51 </span><span class="react-syntax-highlighter-line-number">52 </span><span class="react-syntax-highlighter-line-number">53 </span><span class="react-syntax-highlighter-line-number">54 </span><span class="react-syntax-highlighter-line-number">55 </span><span class="react-syntax-highlighter-line-number">56 </span><span class="react-syntax-highlighter-line-number">57 </span><span class="react-syntax-highlighter-line-number">58 </span><span class="react-syntax-highlighter-line-number">59 </span><span class="react-syntax-highlighter-line-number">60 </span><span class="react-syntax-highlighter-line-number">61 </span><span class="react-syntax-highlighter-line-number">62 </span><span class="react-syntax-highlighter-line-number">63 </span><span class="react-syntax-highlighter-line-number">64 </span><span class="react-syntax-highlighter-line-number">65 </span><span class="react-syntax-highlighter-line-number">66 </span><span class="react-syntax-highlighter-line-number">67 </span><span class="react-syntax-highlighter-line-number">68 </span><span class="react-syntax-highlighter-line-number">69 </span><span class="react-syntax-highlighter-line-number">70 </span><span class="react-syntax-highlighter-line-number">71 </span><span class="react-syntax-highlighter-line-number">72 </span><span class="react-syntax-highlighter-line-number">73 </span><span class="react-syntax-highlighter-line-number">74 </span><span class="react-syntax-highlighter-line-number">75 </span><span class="react-syntax-highlighter-line-number">76 </span><span class="react-syntax-highlighter-line-number">77 </span><span class="react-syntax-highlighter-line-number">78 </span><span class="react-syntax-highlighter-line-number">79 </span><span class="react-syntax-highlighter-line-number">80 </span><span class="react-syntax-highlighter-line-number">81 </span><span class="react-syntax-highlighter-line-number">82 </span><span class="react-syntax-highlighter-line-number">83 </span><span class="react-syntax-highlighter-line-number">84 </span><span class="react-syntax-highlighter-line-number">85 </span><span class="react-syntax-highlighter-line-number">86 </span><span class="react-syntax-highlighter-line-number">87 </span><span class="react-syntax-highlighter-line-number">88 </span><span class="react-syntax-highlighter-line-number">89 </span><span class="react-syntax-highlighter-line-number">90 </span><span class="react-syntax-highlighter-line-number">91 </span><span class="react-syntax-highlighter-line-number">92 </span><span class="react-syntax-highlighter-line-number">93 </span><span class="react-syntax-highlighter-line-number">94 </span><span class="react-syntax-highlighter-line-number">95 </span><span class="react-syntax-highlighter-line-number">96 </span><span class="react-syntax-highlighter-line-number">97 </span><span class="react-syntax-highlighter-line-number">98 </span><span class="react-syntax-highlighter-line-number">99 </span><span class="react-syntax-highlighter-line-number">100 </span><span class="react-syntax-highlighter-line-number">101 </span><span class="react-syntax-highlighter-line-number">102 </span><span class="react-syntax-highlighter-line-number">103 </span><span class="react-syntax-highlighter-line-number">104 </span><span class="react-syntax-highlighter-line-number">105 </span><span class="react-syntax-highlighter-line-number">106 </span><span class="react-syntax-highlighter-line-number">107 </span><span class="react-syntax-highlighter-line-number">108 </span><span class="react-syntax-highlighter-line-number">109 </span><span class="react-syntax-highlighter-line-number">110 </span><span class="react-syntax-highlighter-line-number">111</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px"># Create an API endpoint for graphql lambda resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_rest_api"</span> <span class="token" style="color:#f1fa8c">"gql"</span> <span class="token punctuation">{</span> name = <span class="token" style="color:#f1fa8c">"BlogGraphql"</span> description = <span class="token" style="color:#f1fa8c">"Terraform Serverless GraphQL Example"</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_account"</span> <span class="token" style="color:#f1fa8c">"gql"</span> <span class="token punctuation">{</span> cloudwatch_role_arn = aws_iam_role.cloudwatch.arn <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_role"</span> <span class="token" style="color:#f1fa8c">"cloudwatch"</span> <span class="token punctuation">{</span> name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-api_gateway_cloudwatch_global_gql"</span> assume_role_policy = jsonencode(<span class="token punctuation">{</span> Version = <span class="token" style="color:#f1fa8c">"2012-10-17"</span> <span class="token property">"Statement"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> Sid <span class="token operator">:</span> <span class="token" style="color:#f1fa8c">""</span><span class="token punctuation">,</span> Effect <span class="token operator">:</span> <span class="token" style="color:#f1fa8c">"Allow"</span><span class="token punctuation">,</span> Principal <span class="token operator">:</span> <span class="token punctuation">{</span> Service <span class="token operator">:</span> <span class="token" style="color:#f1fa8c">"apigateway.amazonaws.com"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> Action <span class="token operator">:</span> <span class="token" style="color:#f1fa8c">"sts:AssumeRole"</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>) <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_role_policy_attachment"</span> <span class="token" style="color:#f1fa8c">"cloudwatch_gql"</span> <span class="token punctuation">{</span> policy_arn = <span class="token" style="color:#f1fa8c">"arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"</span> role = aws_iam_role.cloudwatch.name <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Creates method in api gateway for graphql</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_resource"</span> <span class="token" style="color:#f1fa8c">"gql_method"</span> <span class="token punctuation">{</span> rest_api_id = aws_api_gateway_rest_api.gql.id parent_id = aws_api_gateway_rest_api.gql.root_resource_id path_part = <span class="token" style="color:#f1fa8c">"graphql"</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_method"</span> <span class="token" style="color:#f1fa8c">"proxy"</span> <span class="token punctuation">{</span> rest_api_id = aws_api_gateway_rest_api.gql.id resource_id = aws_api_gateway_resource.gql_method.id http_method = <span class="token" style="color:#f1fa8c">"POST"</span> authorization = <span class="token" style="color:#f1fa8c">"NONE"</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// point api to lambda for execution</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_integration"</span> <span class="token" style="color:#f1fa8c">"lambda"</span> <span class="token punctuation">{</span> rest_api_id = aws_api_gateway_rest_api.gql.id resource_id = aws_api_gateway_method.proxy.resource_id http_method = aws_api_gateway_method.proxy.http_method integration_http_method = <span class="token" style="color:#f1fa8c">"POST"</span> type = <span class="token" style="color:#f1fa8c">"AWS_PROXY"</span> uri = aws_lambda_function.gql_lambda.invoke_arn <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_integration"</span> <span class="token" style="color:#f1fa8c">"lambda_root"</span> <span class="token punctuation">{</span> rest_api_id = aws_api_gateway_rest_api.gql.id resource_id = aws_api_gateway_method.proxy_root.resource_id http_method = aws_api_gateway_method.proxy_root.http_method integration_http_method = <span class="token" style="color:#f1fa8c">"POST"</span> type = <span class="token" style="color:#f1fa8c">"AWS_PROXY"</span> uri = aws_lambda_function.gql_lambda.invoke_arn <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_deployment"</span> <span class="token" style="color:#f1fa8c">"gql"</span> <span class="token punctuation">{</span> depends_on = <span class="token punctuation">[</span> aws_api_gateway_integration.lambda<span class="token punctuation">,</span> aws_api_gateway_integration.lambda_root<span class="token punctuation">,</span> <span class="token punctuation">]</span> rest_api_id = aws_api_gateway_rest_api.gql.id stage_name = local.stage_name <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_method"</span> <span class="token" style="color:#f1fa8c">"proxy_root"</span> <span class="token punctuation">{</span> rest_api_id = aws_api_gateway_rest_api.gql.id resource_id = aws_api_gateway_rest_api.gql.root_resource_id http_method = <span class="token" style="color:#f1fa8c">"ANY"</span> authorization = <span class="token" style="color:#f1fa8c">"NONE"</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// Create a custom domain for api</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_domain_name"</span> <span class="token" style="color:#f1fa8c">"graphql"</span> <span class="token punctuation">{</span> certificate_arn = local.graphql_cert_arn domain_name = <span class="token" style="color:#f1fa8c">"graphql.${local.bucket_name}"</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// This creates an A record in Route 53 for graphql subdomain</span> resource <span class="token" style="color:#f1fa8c">"aws_route53_record"</span> <span class="token" style="color:#f1fa8c">"graphql"</span> <span class="token punctuation">{</span> name = aws_api_gateway_domain_name.graphql.domain_name type = <span class="token" style="color:#f1fa8c">"A"</span> zone_id = local.zone_id alias <span class="token punctuation">{</span> evaluate_target_health = <span class="token boolean">true</span> name = aws_api_gateway_domain_name.graphql.cloudfront_domain_name zone_id = aws_api_gateway_domain_name.graphql.cloudfront_zone_id <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// this maps the custom domain to the api</span> resource <span class="token" style="color:#f1fa8c">"aws_api_gateway_base_path_mapping"</span> <span class="token" style="color:#f1fa8c">"example"</span> <span class="token punctuation">{</span> api_id = aws_api_gateway_rest_api.gql.id stage_name = local.stage_name domain_name = aws_api_gateway_domain_name.graphql.domain_name <span class="token punctuation">}</span></code></span></div></div></details><details style="padding-left:1em"><summary><strong>Lambda Terraform:</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21 </span><span class="react-syntax-highlighter-line-number">22 </span><span class="react-syntax-highlighter-line-number">23 </span><span class="react-syntax-highlighter-line-number">24 </span><span class="react-syntax-highlighter-line-number">25 </span><span class="react-syntax-highlighter-line-number">26 </span><span class="react-syntax-highlighter-line-number">27 </span><span class="react-syntax-highlighter-line-number">28 </span><span class="react-syntax-highlighter-line-number">29 </span><span class="react-syntax-highlighter-line-number">30 </span><span class="react-syntax-highlighter-line-number">31 </span><span class="react-syntax-highlighter-line-number">32 </span><span class="react-syntax-highlighter-line-number">33 </span><span class="react-syntax-highlighter-line-number">34 </span><span class="react-syntax-highlighter-line-number">35 </span><span class="react-syntax-highlighter-line-number">36 </span><span class="react-syntax-highlighter-line-number">37 </span><span class="react-syntax-highlighter-line-number">38 </span><span class="react-syntax-highlighter-line-number">39 </span><span class="react-syntax-highlighter-line-number">40 </span><span class="react-syntax-highlighter-line-number">41 </span><span class="react-syntax-highlighter-line-number">42 </span><span class="react-syntax-highlighter-line-number">43 </span><span class="react-syntax-highlighter-line-number">44 </span><span class="react-syntax-highlighter-line-number">45 </span><span class="react-syntax-highlighter-line-number">46 </span><span class="react-syntax-highlighter-line-number">47 </span><span class="react-syntax-highlighter-line-number">48 </span><span class="react-syntax-highlighter-line-number">49 </span><span class="react-syntax-highlighter-line-number">50 </span><span class="react-syntax-highlighter-line-number">51 </span><span class="react-syntax-highlighter-line-number">52 </span><span class="react-syntax-highlighter-line-number">53 </span><span class="react-syntax-highlighter-line-number">54 </span><span class="react-syntax-highlighter-line-number">55 </span><span class="react-syntax-highlighter-line-number">56 </span><span class="react-syntax-highlighter-line-number">57 </span><span class="react-syntax-highlighter-line-number">58 </span><span class="react-syntax-highlighter-line-number">59 </span><span class="react-syntax-highlighter-line-number">60 </span><span class="react-syntax-highlighter-line-number">61 </span><span class="react-syntax-highlighter-line-number">62 </span><span class="react-syntax-highlighter-line-number">63 </span><span class="react-syntax-highlighter-line-number">64 </span><span class="react-syntax-highlighter-line-number">65 </span><span class="react-syntax-highlighter-line-number">66 </span><span class="react-syntax-highlighter-line-number">67 </span><span class="react-syntax-highlighter-line-number">68 </span><span class="react-syntax-highlighter-line-number">69 </span><span class="react-syntax-highlighter-line-number">70 </span><span class="react-syntax-highlighter-line-number">71 </span><span class="react-syntax-highlighter-line-number">72 </span><span class="react-syntax-highlighter-line-number">73 </span><span class="react-syntax-highlighter-line-number">74 </span><span class="react-syntax-highlighter-line-number">75 </span><span class="react-syntax-highlighter-line-number">76 </span><span class="react-syntax-highlighter-line-number">77 </span><span class="react-syntax-highlighter-line-number">78 </span><span class="react-syntax-highlighter-line-number">79 </span><span class="react-syntax-highlighter-line-number">80 </span><span class="react-syntax-highlighter-line-number">81 </span><span class="react-syntax-highlighter-line-number">82 </span><span class="react-syntax-highlighter-line-number">83 </span><span class="react-syntax-highlighter-line-number">84 </span><span class="react-syntax-highlighter-line-number">85 </span><span class="react-syntax-highlighter-line-number">86 </span><span class="react-syntax-highlighter-line-number">87 </span><span class="react-syntax-highlighter-line-number">88 </span><span class="react-syntax-highlighter-line-number">89 </span><span class="react-syntax-highlighter-line-number">90 </span><span class="react-syntax-highlighter-line-number">91 </span><span class="react-syntax-highlighter-line-number">92 </span><span class="react-syntax-highlighter-line-number">93 </span><span class="react-syntax-highlighter-line-number">94 </span><span class="react-syntax-highlighter-line-number">95 </span><span class="react-syntax-highlighter-line-number">96 </span><span class="react-syntax-highlighter-line-number">97 </span><span class="react-syntax-highlighter-line-number">98 </span><span class="react-syntax-highlighter-line-number">99 </span><span class="react-syntax-highlighter-line-number">100 </span><span class="react-syntax-highlighter-line-number">101 </span><span class="react-syntax-highlighter-line-number">102 </span><span class="react-syntax-highlighter-line-number">103 </span><span class="react-syntax-highlighter-line-number">104 </span><span class="react-syntax-highlighter-line-number">105 </span><span class="react-syntax-highlighter-line-number">106 </span><span class="react-syntax-highlighter-line-number">107 </span><span class="react-syntax-highlighter-line-number">108 </span><span class="react-syntax-highlighter-line-number">109 </span><span class="react-syntax-highlighter-line-number">110 </span><span class="react-syntax-highlighter-line-number">111 </span><span class="react-syntax-highlighter-line-number">112 </span><span class="react-syntax-highlighter-line-number">113 </span><span class="react-syntax-highlighter-line-number">114 </span><span class="react-syntax-highlighter-line-number">115 </span><span class="react-syntax-highlighter-line-number">116 </span><span class="react-syntax-highlighter-line-number">117 </span><span class="react-syntax-highlighter-line-number">118 </span><span class="react-syntax-highlighter-line-number">119 </span><span class="react-syntax-highlighter-line-number">120 </span><span class="react-syntax-highlighter-line-number">121 </span><span class="react-syntax-highlighter-line-number">122 </span><span class="react-syntax-highlighter-line-number">123 </span><span class="react-syntax-highlighter-line-number">124 </span><span class="react-syntax-highlighter-line-number">125 </span><span class="react-syntax-highlighter-line-number">126 </span><span class="react-syntax-highlighter-line-number">127 </span><span class="react-syntax-highlighter-line-number">128 </span><span class="react-syntax-highlighter-line-number">129 </span><span class="react-syntax-highlighter-line-number">130</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px"><span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// attach policy to role</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_role_policy_attachment"</span> <span class="token" style="color:#f1fa8c">"sns"</span> <span class="token punctuation">{</span> role = aws_iam_role.iam_for_lambda.name policy_arn = aws_iam_policy.gql_sns.arn <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_role_policy_attachment"</span> <span class="token" style="color:#f1fa8c">"dynamoDb"</span> <span class="token punctuation">{</span> role = aws_iam_role.iam_for_lambda.name policy_arn = aws_iam_policy.gql_dynamoDb.arn <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_role_policy_attachment"</span> <span class="token" style="color:#f1fa8c">"basic"</span> <span class="token punctuation">{</span> policy_arn = <span class="token" style="color:#f1fa8c">"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span> role = aws_iam_role.iam_for_lambda.name <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// create policy</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_policy"</span> <span class="token" style="color:#f1fa8c">"gql_dynamoDb"</span> <span class="token punctuation">{</span> name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-gql-dynamodb"</span> description = <span class="token" style="color:#f1fa8c">"Policy for dynamo db access"</span> policy = data.aws_iam_policy_document.gql_dynamoDb.json <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// create policy document</span> data <span class="token" style="color:#f1fa8c">"aws_iam_policy_document"</span> <span class="token" style="color:#f1fa8c">"gql_dynamoDb"</span> <span class="token punctuation">{</span> statement <span class="token punctuation">{</span> actions = <span class="token punctuation">[</span> <span class="token" style="color:#f1fa8c">"dynamodb:BatchGetItem"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:GetItem"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:Query"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:Scan"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:BatchWriteItem"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:PutItem"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:UpdateItem"</span><span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"dynamodb:DescribeTable"</span> <span class="token punctuation">]</span> effect = <span class="token" style="color:#f1fa8c">"Allow"</span> resources = <span class="token punctuation">[</span>local.dynamo_arn<span class="token punctuation">,</span> <span class="token" style="color:#f1fa8c">"${local.dynamo_arn}/index/*"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// create policy</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_policy"</span> <span class="token" style="color:#f1fa8c">"gql_sns"</span> <span class="token punctuation">{</span> name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}-gql-sns"</span> description = <span class="token" style="color:#f1fa8c">"Policy for sns publish"</span> policy = data.aws_iam_policy_document.gql_sns.json <span class="token punctuation">}</span> data <span class="token" style="color:#f1fa8c">"aws_iam_policy_document"</span> <span class="token" style="color:#f1fa8c">"gql_sns"</span> <span class="token punctuation">{</span> statement <span class="token punctuation">{</span> actions = <span class="token punctuation">[</span> <span class="token" style="color:#f1fa8c">"sns:Publish"</span> <span class="token punctuation">]</span> effect = <span class="token" style="color:#f1fa8c">"Allow"</span> resources = <span class="token punctuation">[</span>local.sns_arn<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_iam_role"</span> <span class="token" style="color:#f1fa8c">"iam_for_lambda"</span> <span class="token punctuation">{</span> name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}_iam_for_gql_lambda"</span> assume_role_policy = jsonencode(<span class="token punctuation">{</span> Version = <span class="token" style="color:#f1fa8c">"2012-10-17"</span> Statement = <span class="token punctuation">[</span> <span class="token punctuation">{</span> Action = <span class="token" style="color:#f1fa8c">"sts:AssumeRole"</span> Effect = <span class="token" style="color:#f1fa8c">"Allow"</span> Sid = <span class="token" style="color:#f1fa8c">""</span> Principal = <span class="token punctuation">{</span> Service = <span class="token" style="color:#f1fa8c">"lambda.amazonaws.com"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> ) <span class="token punctuation">}</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic">// create lambda function</span> resource <span class="token" style="color:#f1fa8c">"aws_lambda_function"</span> <span class="token" style="color:#f1fa8c">"gql_lambda"</span> <span class="token punctuation">{</span> filename = <span class="token" style="color:#f1fa8c">"./function/function.zip"</span> function_name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}_simple_gql_lambda_v"</span> role = aws_iam_role.iam_for_lambda.arn handler = <span class="token" style="color:#f1fa8c">"graphql.graphqlHandler"</span> # The filebase<span class="token" style="color:#bd93f9">64</span>sha<span class="token" style="color:#bd93f9">256</span>() function is available in Terraform <span class="token" style="color:#bd93f9">0.11</span>.<span class="token" style="color:#bd93f9">12</span> and later # For Terraform <span class="token" style="color:#bd93f9">0.11</span>.<span class="token" style="color:#bd93f9">11</span> and earlier<span class="token punctuation">,</span> use the base<span class="token" style="color:#bd93f9">64</span>sha<span class="token" style="color:#bd93f9">256</span>() function and the file() function<span class="token operator">:</span> # source_code_hash = <span class="token" style="color:#f1fa8c">"${base64sha256(file("</span>lambda_function_payload.zip<span class="token" style="color:#f1fa8c">"))}"</span> source_code_hash = filebase<span class="token" style="color:#bd93f9">64</span>sha<span class="token" style="color:#bd93f9">256</span>(<span class="token" style="color:#f1fa8c">"./function/function.zip"</span>) runtime = <span class="token" style="color:#f1fa8c">"nodejs14.x"</span> environment <span class="token punctuation">{</span> variables = <span class="token punctuation">{</span> ddb_table_name = local.dynamo_table_name ddb_hash_key = local.dynamo_hash_key ddb_region = local.region GRAPHQL_ENDPOINT = aws_api_gateway_domain_name.graphql.domain_name SNS_ARN = local.sns_arn OKTA_CLIENT_ID = var.okta_client_id OKTA_CLIENT_SECRET = var.okta_client_secret OKTA_DOMAIN = var.okta_domain OKTA_ISSUER_SUFFIX = var.okta_issuer_suffix OKTA_ISSUER = local.OKTA_ISSUER OKTA_AUDIENCE = var.okta_audience APP_BASE_PORT = <span class="token" style="color:#bd93f9">4000</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> tags = merge( local.base_tags<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name = <span class="token" style="color:#f1fa8c">"${local.resource_prefix}_simple_gql_lambda_v"</span> directory = basename(path.cwd) <span class="token punctuation">}</span><span class="token punctuation">,</span> ) <span class="token punctuation">}</span> resource <span class="token" style="color:#f1fa8c">"aws_lambda_permission"</span> <span class="token" style="color:#f1fa8c">"apigw"</span> <span class="token punctuation">{</span> statement_id = <span class="token" style="color:#f1fa8c">"AllowAPIGatewayInvoke"</span> action = <span class="token" style="color:#f1fa8c">"lambda:InvokeFunction"</span> function_name = aws_lambda_function.gql_lambda.function_name principal = <span class="token" style="color:#f1fa8c">"apigateway.amazonaws.com"</span> # The <span class="token" style="color:#f1fa8c">"/*/*"</span> portion grants access from any method on any resource # within the API Gateway REST API. source_arn = <span class="token" style="color:#f1fa8c">"${aws_api_gateway_rest_api.gql.execution_arn}/*/*"</span> <span class="token punctuation">}</span></code></span></div></div></details></details><br><details style="padding-left:1em"><summary><h2 style="display:inline">Testing React and GraphQL</h2><div class="css-1lyp5n8">We need to build automated testing into our code, even if you start small. My favorite testing tool is <a href="https://www.cypress.io/" target="_blank">Cypress.io</a> and I like to use a docker-compose file to set up a local development environment of networked containers that have my local code mounted as directories. This allows me to continuously build and test with a stable environment that should be the same no matter where I run it. Cypress provides both a desktop tool, where you can watch tests run in real time and observe the state of the browser as it was at any time during the test, and a command line utility that easily integrates into your favorite pipleline tool.</div></summary><details style="padding-left:1em"><summary><strong>Compose File</strong></summary><div><div class="css-1uzs5fn"><span style="font-size:inherit;font-family:inherit;background:#282a36;color:#f8f8f2;border-radius:3px;display:flex;line-height:1.42857;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px 10px 8px 8px;float:left"><span class="react-syntax-highlighter-line-number">1 </span><span class="react-syntax-highlighter-line-number">2 </span><span class="react-syntax-highlighter-line-number">3 </span><span class="react-syntax-highlighter-line-number">4 </span><span class="react-syntax-highlighter-line-number">5 </span><span class="react-syntax-highlighter-line-number">6 </span><span class="react-syntax-highlighter-line-number">7 </span><span class="react-syntax-highlighter-line-number">8 </span><span class="react-syntax-highlighter-line-number">9 </span><span class="react-syntax-highlighter-line-number">10 </span><span class="react-syntax-highlighter-line-number">11 </span><span class="react-syntax-highlighter-line-number">12 </span><span class="react-syntax-highlighter-line-number">13 </span><span class="react-syntax-highlighter-line-number">14 </span><span class="react-syntax-highlighter-line-number">15 </span><span class="react-syntax-highlighter-line-number">16 </span><span class="react-syntax-highlighter-line-number">17 </span><span class="react-syntax-highlighter-line-number">18 </span><span class="react-syntax-highlighter-line-number">19 </span><span class="react-syntax-highlighter-line-number">20 </span><span class="react-syntax-highlighter-line-number">21 </span><span class="react-syntax-highlighter-line-number">22 </span><span class="react-syntax-highlighter-line-number">23 </span><span class="react-syntax-highlighter-line-number">24 </span><span class="react-syntax-highlighter-line-number">25 </span><span class="react-syntax-highlighter-line-number">26 </span><span class="react-syntax-highlighter-line-number">27 </span><span class="react-syntax-highlighter-line-number">28 </span><span class="react-syntax-highlighter-line-number">29 </span><span class="react-syntax-highlighter-line-number">30 </span><span class="react-syntax-highlighter-line-number">31 </span><span class="react-syntax-highlighter-line-number">32 </span><span class="react-syntax-highlighter-line-number">33 </span><span class="react-syntax-highlighter-line-number">34 </span><span class="react-syntax-highlighter-line-number">35 </span><span class="react-syntax-highlighter-line-number">36 </span><span class="react-syntax-highlighter-line-number">37 </span><span class="react-syntax-highlighter-line-number">38 </span><span class="react-syntax-highlighter-line-number">39 </span><span class="react-syntax-highlighter-line-number">40 </span><span class="react-syntax-highlighter-line-number">41 </span><span class="react-syntax-highlighter-line-number">42 </span><span class="react-syntax-highlighter-line-number">43 </span><span class="react-syntax-highlighter-line-number">44 </span><span class="react-syntax-highlighter-line-number">45 </span><span class="react-syntax-highlighter-line-number">46</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.66667;padding:8px"><span class="token atrule" style="color:#ff79c6;font-weight:bolder">version</span><span class="token punctuation">:</span> <span class="token" style="color:#f1fa8c">"3.9"</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># optional since v1.27.0</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">services</span><span class="token punctuation">:</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># UI container - uses command from package.json file to start</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># need to install nodemon</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">react</span><span class="token punctuation">:</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span><span class="token" style="color:#bd93f9">16</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">command</span><span class="token punctuation">:</span> /bin/bash <span class="token punctuation">-</span>c "ls & npm install nodemon <span class="token punctuation">-</span>g && yarn start<span class="token punctuation">:</span>nodemon" <span class="token atrule" style="color:#ff79c6;font-weight:bolder">ports</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> <span class="token" style="color:#f1fa8c">"3001:3001"</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">volumes</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> ./ui<span class="token punctuation">:</span>/src <span class="token atrule" style="color:#ff79c6;font-weight:bolder">working_dir</span><span class="token punctuation">:</span> /src <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># This variable is used in App.js, if it exists then it points to this endpoint</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># with docker network the service name (graphql) is all we need to route</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># ui should be running at http://localhost:3001/</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">environment</span><span class="token punctuation">:</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">DOCKER_GRAPHQL_ENDPOINT</span><span class="token punctuation">:</span> graphql <span class="token atrule" style="color:#ff79c6;font-weight:bolder">dynamodb</span><span class="token punctuation">:</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">image</span><span class="token punctuation">:</span> amazon/dynamodb<span class="token punctuation">-</span>local<span class="token punctuation">:</span>1.17.0 <span class="token atrule" style="color:#ff79c6;font-weight:bolder">ports</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> <span class="token" style="color:#f1fa8c">"8000:8000"</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># gives container a drive to mount</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">volumes</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> ./terraform/terraform_graphql/function/dynamodb<span class="token punctuation">:</span>/home/dynamodblocal/data <span class="token atrule" style="color:#ff79c6;font-weight:bolder">working_dir</span><span class="token punctuation">:</span> /home/dynamodblocal <span class="token atrule" style="color:#ff79c6;font-weight:bolder">graphql</span><span class="token punctuation">:</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span><span class="token" style="color:#bd93f9">16</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">command</span><span class="token punctuation">:</span> /bin/bash <span class="token punctuation">-</span>c "ls & npm install nodemon <span class="token punctuation">-</span>g && nodemon index.js" <span class="token atrule" style="color:#ff79c6;font-weight:bolder">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> dynamodb <span class="token atrule" style="color:#ff79c6;font-weight:bolder">ports</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> <span class="token" style="color:#f1fa8c">"4000:4000"</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">volumes</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> ./terraform/terraform_graphql/function/src<span class="token punctuation">:</span>/src <span class="token punctuation">-</span> $HOME/.aws/credentials<span class="token punctuation">:</span>/root/.aws/credentials <span class="token atrule" style="color:#ff79c6;font-weight:bolder">working_dir</span><span class="token punctuation">:</span> /src <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># graphql should be running at http://localhost:4000/graphql</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">environment</span><span class="token punctuation">:</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># This value tells graphql to point at local version of dynamodb if it exists</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">CYPRESS_GRAPHQL</span><span class="token punctuation">:</span> <span class="token" style="color:#f1fa8c">"true"</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">GRAPHQL_PORT</span><span class="token punctuation">:</span> <span class="token" style="color:#bd93f9">4000</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># Tells graphql to ignore the need for authentication</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">JWT_OVERRIDE</span><span class="token punctuation">:</span> <span class="token" style="color:#f1fa8c">"true"</span> <span class="token" style="color:#6272a4;font-family:inherit;font-style:italic"># points to service running above</span> <span class="token atrule" style="color:#ff79c6;font-weight:bolder">DYNAMO_HOST</span><span class="token punctuation">:</span> dynamodb</code></span></div></div></details><br><div class="css-1lyp5n8">Here the pipeline runs Cypress tests that cover ui and graphql</div><img class="css-1stgykt" src="/images/6/yaml9.png"><div class="css-1lyp5n8">This part builds the React project and uploads it to S3 bucket:</div><img class="css-1stgykt" src="/images/6/yaml10.png"><div class="css-1lyp5n8">This conditionally updates the Cloudfront distribution if Terraform files have changed:</div><img class="css-1stgykt" src="/images/6/yaml11.png"></details><br><br></div></div></div><div>Error: Failed to fetch</div></div></div></div><script>!function(a){function r(r){for(var t,c,_=r[0],n=r[1],i=r[2],l=0,o=[];l<_.length;l++)c=_[l],Object.prototype.hasOwnProperty.call(g,c)&&g[c]&&o.push(g[c][0]),g[c]=0;for(t in n)Object.prototype.hasOwnProperty.call(n,t)&&(a[t]=n[t]);for(s&&s(r);o.length;)o.shift()();return h.push.apply(h,i||[]),e()}function e(){for(var a,r=0;r<h.length;r++){for(var e=h[r],t=!0,_=1;_<e.length;_++){var n=e[_];0!==g[n]&&(t=!1)}t&&(h.splice(r--,1),a=c(c.s=e[0]))}return a}var t={},g={152:0},h=[];function c(r){if(t[r])return t[r].exports;var e=t[r]={i:r,l:!1,exports:{}};return a[r].call(e.exports,e,e.exports,c),e.l=!0,e.exports}c.e=function(a){var r=[],e=g[a];if(0!==e)if(e)r.push(e[2]);else{var t=new Promise((function(r,t){e=g[a]=[r,t]}));r.push(e[2]=t);var h,_=document.createElement("script");_.charset="utf-8",_.timeout=120,c.nc&&_.setAttribute("nonce",c.nc),_.src=function(a){return c.p+"static/js/"+({1:"react-syntax-highlighter_languages_refractor_abap",2:"react-syntax-highlighter_languages_refractor_actionscript",3:"react-syntax-highlighter_languages_refractor_ada",4:"react-syntax-highlighter_languages_refractor_apacheconf",5:"react-syntax-highlighter_languages_refractor_apl",6:"react-syntax-highlighter_languages_refractor_applescript",7:"react-syntax-highlighter_languages_refractor_arduino",8:"react-syntax-highlighter_languages_refractor_arff",9:"react-syntax-highlighter_languages_refractor_asciidoc",10:"react-syntax-highlighter_languages_refractor_asm6502",11:"react-syntax-highlighter_languages_refractor_aspnet",12:"react-syntax-highlighter_languages_refractor_autohotkey",13:"react-syntax-highlighter_languages_refractor_autoit",14:"react-syntax-highlighter_languages_refractor_bash",15:"react-syntax-highlighter_languages_refractor_basic",16:"react-syntax-highlighter_languages_refractor_batch",17:"react-syntax-highlighter_languages_refractor_bison",18:"react-syntax-highlighter_languages_refractor_brainfuck",19:"react-syntax-highlighter_languages_refractor_bro",20:"react-syntax-highlighter_languages_refractor_c",21:"react-syntax-highlighter_languages_refractor_clike",22:"react-syntax-highlighter_languages_refractor_clojure",23:"react-syntax-highlighter_languages_refractor_coffeescript",24:"react-syntax-highlighter_languages_refractor_cpp",25:"react-syntax-highlighter_languages_refractor_crystal",26:"react-syntax-highlighter_languages_refractor_csharp",27:"react-syntax-highlighter_languages_refractor_csp",28:"react-syntax-highlighter_languages_refractor_css",29:"react-syntax-highlighter_languages_refractor_cssExtras",30:"react-syntax-highlighter_languages_refractor_d",31:"react-syntax-highlighter_languages_refractor_dart",32:"react-syntax-highlighter_languages_refractor_diff",33:"react-syntax-highlighter_languages_refractor_django",34:"react-syntax-highlighter_languages_refractor_docker",35:"react-syntax-highlighter_languages_refractor_eiffel",36:"react-syntax-highlighter_languages_refractor_elixir",37:"react-syntax-highlighter_languages_refractor_elm",38:"react-syntax-highlighter_languages_refractor_erb",39:"react-syntax-highlighter_languages_refractor_erlang",40:"react-syntax-highlighter_languages_refractor_flow",41:"react-syntax-highlighter_languages_refractor_fortran",42:"react-syntax-highlighter_languages_refractor_fsharp",43:"react-syntax-highlighter_languages_refractor_gedcom",44:"react-syntax-highlighter_languages_refractor_gherkin",45:"react-syntax-highlighter_languages_refractor_git",46:"react-syntax-highlighter_languages_refractor_glsl",47:"react-syntax-highlighter_languages_refractor_go",48:"react-syntax-highlighter_languages_refractor_graphql",49:"react-syntax-highlighter_languages_refractor_groovy",50:"react-syntax-highlighter_languages_refractor_haml",51:"react-syntax-highlighter_languages_refractor_handlebars",52:"react-syntax-highlighter_languages_refractor_haskell",53:"react-syntax-highlighter_languages_refractor_haxe",54:"react-syntax-highlighter_languages_refractor_hpkp",55:"react-syntax-highlighter_languages_refractor_hsts",56:"react-syntax-highlighter_languages_refractor_http",57:"react-syntax-highlighter_languages_refractor_ichigojam",58:"react-syntax-highlighter_languages_refractor_icon",59:"react-syntax-highlighter_languages_refractor_inform7",60:"react-syntax-highlighter_languages_refractor_ini",61:"react-syntax-highlighter_languages_refractor_io",62:"react-syntax-highlighter_languages_refractor_j",63:"react-syntax-highlighter_languages_refractor_java",64:"react-syntax-highlighter_languages_refractor_javascript",65:"react-syntax-highlighter_languages_refractor_jolie",66:"react-syntax-highlighter_languages_refractor_json",67:"react-syntax-highlighter_languages_refractor_jsx",68:"react-syntax-highlighter_languages_refractor_julia",69:"react-syntax-highlighter_languages_refractor_keyman",70:"react-syntax-highlighter_languages_refractor_kotlin",71:"react-syntax-highlighter_languages_refractor_latex",72:"react-syntax-highlighter_languages_refractor_less",73:"react-syntax-highlighter_languages_refractor_liquid",74:"react-syntax-highlighter_languages_refractor_lisp",75:"react-syntax-highlighter_languages_refractor_livescript",76:"react-syntax-highlighter_languages_refractor_lolcode",77:"react-syntax-highlighter_languages_refractor_lua",78:"react-syntax-highlighter_languages_refractor_makefile",79:"react-syntax-highlighter_languages_refractor_markdown",80:"react-syntax-highlighter_languages_refractor_markup",81:"react-syntax-highlighter_languages_refractor_markupTemplating",82:"react-syntax-highlighter_languages_refractor_matlab",83:"react-syntax-highlighter_languages_refractor_mel",84:"react-syntax-highlighter_languages_refractor_mizar",85:"react-syntax-highlighter_languages_refractor_monkey",86:"react-syntax-highlighter_languages_refractor_n4js",87:"react-syntax-highlighter_languages_refractor_nasm",88:"react-syntax-highlighter_languages_refractor_nginx",89:"react-syntax-highlighter_languages_refractor_nim",90:"react-syntax-highlighter_languages_refractor_nix",91:"react-syntax-highlighter_languages_refractor_nsis",92:"react-syntax-highlighter_languages_refractor_objectivec",93:"react-syntax-highlighter_languages_refractor_ocaml",94:"react-syntax-highlighter_languages_refractor_opencl",95:"react-syntax-highlighter_languages_refractor_oz",96:"react-syntax-highlighter_languages_refractor_parigp",97:"react-syntax-highlighter_languages_refractor_parser",98:"react-syntax-highlighter_languages_refractor_pascal",99:"react-syntax-highlighter_languages_refractor_perl",100:"react-syntax-highlighter_languages_refractor_php",101:"react-syntax-highlighter_languages_refractor_phpExtras",102:"react-syntax-highlighter_languages_refractor_plsql",103:"react-syntax-highlighter_languages_refractor_powershell",104:"react-syntax-highlighter_languages_refractor_processing",105:"react-syntax-highlighter_languages_refractor_prolog",106:"react-syntax-highlighter_languages_refractor_properties",107:"react-syntax-highlighter_languages_refractor_protobuf",108:"react-syntax-highlighter_languages_refractor_pug",109:"react-syntax-highlighter_languages_refractor_puppet",110:"react-syntax-highlighter_languages_refractor_pure",111:"react-syntax-highlighter_languages_refractor_python",112:"react-syntax-highlighter_languages_refractor_q",113:"react-syntax-highlighter_languages_refractor_qore",114:"react-syntax-highlighter_languages_refractor_r",115:"react-syntax-highlighter_languages_refractor_reason",116:"react-syntax-highlighter_languages_refractor_renpy",117:"react-syntax-highlighter_languages_refractor_rest",118:"react-syntax-highlighter_languages_refractor_rip",119:"react-syntax-highlighter_languages_refractor_roboconf",120:"react-syntax-highlighter_languages_refractor_ruby",121:"react-syntax-highlighter_languages_refractor_rust",122:"react-syntax-highlighter_languages_refractor_sas",123:"react-syntax-highlighter_languages_refractor_sass",124:"react-syntax-highlighter_languages_refractor_scala",125:"react-syntax-highlighter_languages_refractor_scheme",126:"react-syntax-highlighter_languages_refractor_scss",127:"react-syntax-highlighter_languages_refractor_smalltalk",128:"react-syntax-highlighter_languages_refractor_smarty",129:"react-syntax-highlighter_languages_refractor_soy",130:"react-syntax-highlighter_languages_refractor_sql",131:"react-syntax-highlighter_languages_refractor_stylus",132:"react-syntax-highlighter_languages_refractor_swift",133:"react-syntax-highlighter_languages_refractor_tap",134:"react-syntax-highlighter_languages_refractor_tcl",135:"react-syntax-highlighter_languages_refractor_textile",136:"react-syntax-highlighter_languages_refractor_tsx",137:"react-syntax-highlighter_languages_refractor_tt2",138:"react-syntax-highlighter_languages_refractor_twig",139:"react-syntax-highlighter_languages_refractor_typescript",140:"react-syntax-highlighter_languages_refractor_vbnet",141:"react-syntax-highlighter_languages_refractor_velocity",142:"react-syntax-highlighter_languages_refractor_verilog",143:"react-syntax-highlighter_languages_refractor_vhdl",144:"react-syntax-highlighter_languages_refractor_vim",145:"react-syntax-highlighter_languages_refractor_visualBasic",146:"react-syntax-highlighter_languages_refractor_wasm",147:"react-syntax-highlighter_languages_refractor_wiki",148:"react-syntax-highlighter_languages_refractor_xeora",149:"react-syntax-highlighter_languages_refractor_xojo",150:"react-syntax-highlighter_languages_refractor_xquery",151:"react-syntax-highlighter_languages_refractor_yaml"}[a]||a)+"."+{1:"5ce0a218",2:"c91906ac",3:"adb19a44",4:"cc59464f",5:"f8993fd3",6:"66911c33",7:"5678a631",8:"d949ca17",9:"11560d88",10:"4e2e0fa1",11:"834e2292",12:"2ce03349",13:"0a73301c",14:"e194bbbb",15:"f026f83e",16:"2510a051",17:"3025470a",18:"83c4b6a1",19:"625bc7e9",20:"425910a3",21:"0955efde",22:"49466316",23:"1e18b429",24:"89a4c21a",25:"97091f1c",26:"fb21a125",27:"efcc5dec",28:"798fc99c",29:"a64f1295",30:"2ad7f268",31:"752a7496",32:"ce8cb85b",33:"f252dd21",34:"e5a0a512",35:"4a522aed",36:"583b5291",37:"41627fdd",38:"a60636d5",39:"7d2b660e",40:"9f9caa05",41:"33e0a0be",42:"7ad17005",43:"3dd1d2cc",44:"af660035",45:"9bbd406f",46:"f33a63fe",47:"a527f8cd",48:"78ecb5b0",49:"fa62ae82",50:"bcab50bd",51:"68786be8",52:"0fc354df",53:"7b33298d",54:"5389b745",55:"b6b2694f",56:"e69823e4",57:"e9fffe32",58:"29b25347",59:"9ecb9913",60:"3019a210",61:"1c1966ce",62:"b0f01e61",63:"b668e591",64:"ae7fe12c",65:"fba34806",66:"4e8e5b51",67:"afd8d23f",68:"e9bc2e28",69:"e1b48b11",70:"71e13449",71:"ed9bd742",72:"d63c29a7",73:"ec563105",74:"be07d8f7",75:"c45c435f",76:"eec3a11a",77:"c71772c6",78:"83403a42",79:"39fb8379",80:"5c2cc6db",81:"54a1b646",82:"5dd28799",83:"3d6f1c42",84:"c07eea11",85:"132da623",86:"4d8dcfe2",87:"90a2605d",88:"b06436d9",89:"c15e7982",90:"13c30075",91:"c5451263",92:"82528a50",93:"b29b2026",94:"6f6bdd6b",95:"8e8a5aee",96:"ff046490",97:"014571a1",98:"5d510ebc",99:"28d00c1e",100:"10e5a5e8",101:"b350c939",102:"0c72bb14",103:"8a37cff1",104:"31f0e00c",105:"11333ac6",106:"cfcd1faf",107:"0dd25f3d",108:"636e0118",109:"f1d8d625",110:"21f631b6",111:"b5d4777f",112:"c4cd0a66",113:"c098c4a9",114:"1676e00f",115:"e3116b4b",116:"75af7e7f",117:"e3ebfa0b",118:"df0c16e9",119:"d0d38da4",120:"db9cbd2b",121:"1ed3e15e",122:"7de42bad",123:"dda9ddd6",124:"c9201289",125:"8469f737",126:"a3728a0d",127:"4f072bc0",128:"35b326fb",129:"efd892a8",130:"2e9f1735",131:"b4f7d9a6",132:"0177a5f0",133:"aee746a2",134:"cdb64fd8",135:"e3087533",136:"a2157c33",137:"6511895c",138:"214f604f",139:"cfd6aa4b",140:"14ec90ac",141:"b6a54011",142:"940c431c",143:"bc223863",144:"69f5b598",145:"e11aa54e",146:"724f305c",147:"f0739ea2",148:"221a4511",149:"b9295dfa",150:"b70d910a",151:"aaa07edf",154:"730b755d",155:"2b1e9348",156:"1326124f",157:"db2df864",158:"5a401d60",159:"a6b932ab",160:"b424bf2f",161:"9ae70339"}[a]+".chunk.js"}(a);var n=new Error;h=function(r){_.onerror=_.onload=null,clearTimeout(i);var e=g[a];if(0!==e){if(e){var t=r&&("load"===r.type?"missing":r.type),h=r&&r.target&&r.target.src;n.message="Loading chunk "+a+" failed.\n("+t+": "+h+")",n.name="ChunkLoadError",n.type=t,n.request=h,e[1](n)}g[a]=void 0}};var i=setTimeout((function(){h({type:"timeout",target:_})}),12e4);_.onerror=_.onload=h,document.head.appendChild(_)}return Promise.all(r)},c.m=a,c.c=t,c.d=function(a,r,e){c.o(a,r)||Object.defineProperty(a,r,{enumerable:!0,get:e})},c.r=function(a){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})},c.t=function(a,r){if(1&r&&(a=c(a)),8&r)return a;if(4&r&&"object"==typeof a&&a&&a.__esModule)return a;var e=Object.create(null);if(c.r(e),Object.defineProperty(e,"default",{enumerable:!0,value:a}),2&r&&"string"!=typeof a)for(var t in a)c.d(e,t,function(r){return a[r]}.bind(null,t));return e},c.n=function(a){var r=a&&a.__esModule?function(){return a.default}:function(){return a};return c.d(r,"a",r),r},c.o=function(a,r){return Object.prototype.hasOwnProperty.call(a,r)},c.p="/",c.oe=function(a){throw console.error(a),a};var _=this["webpackJsonpblog-site"]=this["webpackJsonpblog-site"]||[],n=_.push.bind(_);_.push=r,_=_.slice();for(var i=0;i<_.length;i++)r(_[i]);var s=n;e()}([])</script><script src="/static/js/153.2eb38fd0.chunk.js"></script><script src="/static/js/main.59b35fd3.chunk.js"></script></body></html>